# **Technical Implementation Details: REQ-003**

## **Requirement: Use Form Requests for Validation**

> **User Story:** As a developer, I want to use Form Request classes for all `POST`/`PUT`/`PATCH` validation so that validation is centralized and reusable.

---

### **Objective**

To eliminate manual validation logic from controllers by creating dedicated Form Request classes for all create and update operations. This centralizes validation and authorization rules, making controllers cleaner and the rules themselves reusable and easier to test.

### **Implementation Steps**

Following the example from REQ-002, we will create the `StoreOrderRequest` used in the refactored `OrderController`.

**Scenario:** The controller needs to validate incoming data for creating a new order.

---

1.  **Create the Form Request Class:**
    *   Use the `make:request` Artisan command to generate a new Form Request class. By convention, these are stored in `app/Http/Requests`.
    *   **Command:**
        ```bash
        php artisan make:request StoreOrderRequest
        ```
    *   This command will create the file `app/Http/Requests/StoreOrderRequest.php`.

2.  **Implement the `authorize()` Method:**
    *   This method controls access to the route. It should return `true` if the user is authorized to perform the request, and `false` otherwise. Returning `false` will result in a 403 Forbidden response.
    *   For this example, we'll simply check if the user is authenticated.
    *   **Modification in `app/Http/Requests/StoreOrderRequest.php`:**
    ```php
    /**
     * Determine if the user is authorized to make this request.
     */
    public function authorize(): bool
    {
        // Only authenticated users can create an order.
        return auth()->check();
    }
    ```

3.  **Implement the `rules()` Method:**
    *   This method should return an array of validation rules that apply to the request's data. These are the same rules that would have been used in `$request->validate()`.
    *   **Modification in `app/Http/Requests/StoreOrderRequest.php`:**
    ```php
    /**
     * Get the validation rules that apply to the request.
     *
     * @return array<string, \Illuminate\Contracts\Validation\ValidationRule|array|string>
     */
    public function rules(): array
    {
        return [
            'product_id' => 'required|integer|exists:products,id',
            'quantity' => 'required|integer|min:1',
        ];
    }
    ```

4.  **Refactor the Controller to Use the Form Request:**
    *   Type-hint the newly created `StoreOrderRequest` in the controller method's signature. Laravel's service container will automatically resolve and run the Form Request's authorization and validation logic before the controller method is executed.
    *   If validation fails, a `ValidationException` will be thrown automatically, redirecting the user back with the errors.
    *   Replace any manual validation calls with `$request->validated()` to retrieve the validated data.
    *   **File:** `app/Http/Controllers/OrderController.php`
    ```php
    <?php

    namespace App\Http\Controllers;

    use App\Http\Requests\StoreOrderRequest; // Import the new class
    use Domain\Orders\Actions\CreateOrderAction;
    use Domain\Orders\Data\CreateOrderData;

    class OrderController extends Controller
    {
        // Type-hint the Form Request here
        public function store(StoreOrderRequest $request, CreateOrderAction $createOrder)
        {
            // The request is already validated at this point.
            // No need for $request->validate(...) anymore.

            $orderData = CreateOrderData::from([
                ...$request->validated(), // Use the validated data
                'user_id' => auth()->id(),
            ]);

            $order = $createOrder($orderData);

            return redirect()->route('orders.show', $order)
                ->with('success', 'Order created successfully.');
        }
    }
    ```

### **Verification**

1.  The controller method no longer contains any calls to `validate()` or `Validator::make()`.
2.  The controller method signature is updated to type-hint the `StoreOrderRequest`.
3.  The `app/Http/Requests/StoreOrderRequest.php` file exists and contains the correct `authorize()` and `rules()` logic.
4.  Submitting a request to the `store` endpoint with invalid data results in a validation error response, without the controller method ever being executed.
5.  Submitting a request as an unauthenticated user results in a 403 Forbidden response.

### **Risks and Mitigation**

*   **Risk:** Authorization logic is forgotten or is too permissive.
    *   **Mitigation:** Always implement a conscious authorization check in the `authorize()` method. Never just `return true` without considering the security implications. Write a feature test that attempts to access the endpoint as an unauthorized user and asserts a 403 response.
