# **Technical Implementation Details: REQ-005**

## **Requirement: Configure Larastan**

> **User Story:** As a developer, I want Larastan configured with a `phpstan.neon.dist` file (level 5) so that static analysis can find potential bugs.

---

### **Objective**

To install and configure Larastan, a static analysis tool based on PHPStan, to detect potential bugs, type errors, and other inconsistencies in the codebase before it is executed.

### **Implementation Steps**

1.  **Install Larastan:**
    *   Add Larastan to the project as a `require-dev` dependency using Composer.
    *   **Command:**
        ```bash
        composer require --dev larastan/larastan
        ```

2.  **Create `phpstan.neon.dist` Configuration File:**
    *   In the project root, create a new file named `phpstan.neon.dist`. The `.dist` extension signifies that this is a distributable, default configuration file that can be overridden by a local `phpstan.neon` if needed.
    *   **Command:**
        ```bash
        touch phpstan.neon.dist
        ```

3.  **Add Larastan Configuration:**
    *   Populate the `phpstan.neon.dist` file with the configuration specified in the project standards. This includes the Larastan extension, the paths to be analyzed (`app` and `src`), and the analysis level. Level 5 is a sensible default that provides a good balance of strictness and productivity for Laravel projects.
    *   **Content for `phpstan.neon.dist`:**
        ```yaml
        includes:
            - ./vendor/larastan/larastan/extension.neon

        parameters:
            paths:
                - app
                - src

            # The level 5 provides a great balance between finding bugs and staying productive.
            level: 5

            ignoreErrors:
                # This section can be used to ignore specific, unavoidable errors.
                # For example, if a package has known issues with static analysis.
                # - '#Call to an undefined method Illuminate\Database\Eloquent\Builder::whereSomething\(\).#'

            excludePaths:
                # This section can be used to exclude files from analysis.
                # - ./*/_ide_helper.php
        ```

4.  **Perform Initial Analysis:**
    *   Run Larastan on the codebase to get an initial report of any existing issues.
    *   **Command:**
        ```bash
        ./vendor/bin/phpstan analyse
        ```
    *   Address any reported errors. This may involve fixing bugs, adding missing type hints (especially PHPDoc blocks for Laravel's "magic" methods), or, if an error is a false positive, adding it to the `ignoreErrors` section of `phpstan.neon.dist`.

5.  **Document Usage:**
    *   Update the project's `CONTRIBUTING.md` (REQ-010) to include instructions for running the static analysis check locally before submitting a pull request.
    *   **Command:**
        ```bash
        ./vendor/bin/phpstan analyse
        ```

### **Verification**

1.  The `phpstan.neon.dist` file exists in the project root with the correct configuration.
2.  Running `./vendor/bin/phpstan analyse` on the clean codebase returns a `[OK] No errors` message.
3.  Intentionally introducing a type error into a PHP file (e.g., passing a string to a method that expects an int) and running `./vendor/bin/phpstan analyse` results in a failed exit code and an error message detailing the file, line number, and nature of the error.

### **Risks and Mitigation**

*   **Risk:** The static analysis process reports a large number of "errors" related to Laravel's magic methods, leading to frustration and developers ignoring the output.
    *   **Mitigation:** Use the `barryvdh/laravel-ide-helper` package (part of REQ-009) to generate helper files that provide concrete type information for models, facades, and other dynamic parts of the framework. This will significantly improve Larastan's accuracy. For any remaining unavoidable errors, use the `ignoreErrors` configuration parameter judiciously.
*   **Risk:** A developer commits code that fails static analysis.
    *   **Mitigation:** This risk is mitigated by the CI pipeline (REQ-007), which will run `./vendor/bin/phpstan analyse` on every pull request, blocking any non-compliant code from being merged.
