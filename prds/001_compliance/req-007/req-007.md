# **Technical Implementation Details: REQ-007**

## **Requirement: Create GitHub Actions CI Pipeline**

> **User Story:** As a developer, I want a GitHub Actions CI pipeline that runs Pint, Larastan, and Pest so that code quality is automatically enforced.

---

### **Objective**

To create a Continuous Integration (CI) pipeline using GitHub Actions that automatically runs the project's quality assurance toolchain (code styling, static analysis, and testing) on every push and pull request to the main branches.

### **Implementation Steps**

1.  **Create Workflow Directory:**
    *   In the project root, create the necessary directory structure for GitHub Actions workflows.
    *   **Command:**
        ```bash
        mkdir -p .github/workflows
        ```

2.  **Create `ci.yml` Workflow File:**
    *   Inside the `.github/workflows` directory, create a new file named `ci.yml`.
    *   **Command:**
        ```bash
        touch .github/workflows/ci.yml
        ```

3.  **Define the CI Workflow:**
    *   Populate the `ci.yml` file with the complete, annotated workflow definition from the project standards document. This workflow consists of three separate jobs that can run in parallel: `lint`, `analyse`, and `test`.
    *   **Content for `.github/workflows/ci.yml`:**
        ```yaml
        name: CI

        on:
          push:
            branches: [ "main", "develop" ]
          pull_request:
            branches: [ "main", "develop" ]

        jobs:
          lint:
            name: Code Style
            runs-on: ubuntu-latest
            steps:
              - name: Checkout code
                uses: actions/checkout@v4

              - name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                  php-version: '8.3'
                  extensions: mbstring, dom, fileinfo
                  coverage: none

              - name: Install Composer dependencies
                uses: ramsey/composer-install@v2

              - name: Run Pint
                run: ./vendor/bin/pint --test

          analyse:
            name: Static Analysis
            runs-on: ubuntu-latest
            steps:
              - name: Checkout code
                uses: actions/checkout@v4

              - name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                  php-version: '8.3'
                  extensions: mbstring, dom, fileinfo, mysql
                  coverage: none

              - name: Install Composer dependencies
                uses: ramsey/composer-install@v2

              - name: Run Larastan
                run: ./vendor/bin/phpstan analyse

          test:
            name: Testing
            runs-on: ubuntu-latest
            services:
              mysql:
                image: mysql:8.0
                env:
                  MYSQL_ROOT_PASSWORD: password
                  MYSQL_DATABASE: testing
                ports:
                  - 3306:3306
                options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

            steps:
              - name: Checkout code
                uses: actions/checkout@v4

              - name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                  php-version: '8.3'
                  extensions: mbstring, dom, fileinfo, pdo, pdo_mysql
                  coverage: none

              - name: Install Composer dependencies
                uses: ramsey/composer-install@v2

              - name: Prepare Laravel Application
                run: |
                  cp .env.example .env.ci
                  sed -i 's/DB_CONNECTION=sqlite/DB_CONNECTION=mysql/' .env.ci
                  sed -i 's/DB_HOST=127.0.0.1/DB_HOST=127.0.0.1/' .env.ci
                  sed -i 's/# DB_PORT=3306/DB_PORT=3306/' .env.ci
                  sed -i 's/DB_DATABASE=laravel/DB_DATABASE=testing/' .env.ci
                  sed -i 's/DB_USERNAME=root/DB_USERNAME=root/' .env.ci
                  sed -i 's/# DB_PASSWORD=/DB_PASSWORD=password/' .env.ci
                  cp .env.ci .env
                  php artisan key:generate

              - name: Run Migrations
                run: php artisan migrate --force

              - name: Run Pest Tests
                run: ./vendor/bin/pest
        ```

4.  **Commit and Push:**
    *   Commit the `.github/workflows/ci.yml` file and push it to the remote repository. The workflow will be automatically enabled.

### **Verification**

1.  After pushing the `ci.yml` file, navigate to the "Actions" tab in the project's GitHub repository. You should see the "CI" workflow listed.
2.  Open a pull request against the `main` or `develop` branch.
3.  The CI workflow should trigger automatically. Verify that all three jobs (`lint`, `analyse`, `test`) are executed.
4.  If all tools pass, the workflow should complete successfully with a green checkmark.
5.  Intentionally introduce an error (e.g., a style issue, a type error, or a failing test) and push it in a pull request. Verify that the corresponding job fails and the pull request shows a red "X", indicating that the checks have not passed.

### **Risks and Mitigation**

*   **Risk:** The CI environment configuration (PHP extensions, database connection) drifts from the local development environment, causing tests to pass locally but fail in CI (or vice-versa).
    *   **Mitigation:** Use Laravel Sail or Docker for local development to ensure the local environment is as close as possible to the containerized CI environment. Keep PHP versions and extensions synchronized between the `shivammathur/setup-php` action and the local Dockerfile.
*   **Risk:** The CI pipeline becomes slow, discouraging developers.
    *   **Mitigation:** The current setup runs three jobs in parallel, which is efficient. For larger projects, consider implementing Composer caching in the workflow to speed up the `composer install` step. Additionally, Pest's parallel testing features can be enabled to further speed up the `test` job.
