# **Technical Implementation Details: REQ-006**

## **Requirement: Migrate to Pest**

> **User Story:** As a developer, I want the project's testing framework to be Pest so that tests are more readable and expressive.

---

### **Objective**

To replace the default PHPUnit testing framework setup with Pest. This involves installing Pest, converting existing tests to Pest's function-based syntax, and establishing architectural testing as a practice.

### **Implementation Steps**

1.  **Install Pest and Laravel Plugin:**
    *   Add Pest and its dedicated Laravel plugin as `require-dev` dependencies using Composer.
    *   **Command:**
        ```bash
        composer require --dev pestphp/pest pestphp/pest-plugin-laravel
        ```

2.  **Run Pest Installation Command:**
    *   Execute the `pest:install` Artisan command. This command will:
        *   Create a `tests/Pest.php` file, which serves as the entry point for the test suite.
        *   Update the `phpunit.xml` file to properly configure it for Pest.
        *   Create a sample `tests/Feature/ExampleTest.php` and `tests/Unit/ExampleTest.php` in Pest syntax.
    *   **Command:**
        ```bash
        php artisan pest:install
        ```
    *   **Note:** Since existing `ExampleTest.php` files exist, the command may ask to overwrite them. Allow this, as they will be replaced with Pest-syntax examples.

3.  **Convert Existing PHPUnit Tests:**
    *   Manually refactor the existing tests from PHPUnit's class-based syntax to Pest's simpler, function-based syntax.
    *   **Example Conversion (`HelloWorldTest.php`):**

        **Before (PHPUnit):**
        ```php
        <?php

        namespace Tests\Feature;

        use Tests\TestCase;

        class HelloWorldTest extends TestCase
        {
            public function test_hello_world_returns_a_successful_response(): void
            {
                $response = $this->get('/');
                $response->assertStatus(200);
            }
        }
        ```

        **After (Pest):**
        ```php
        <?php

test('hello world returns a successful response', function () {
    $response = $this->get('/');
    $response->assertStatus(200);
});
        ```
    *   Apply this conversion to all existing test files in `tests/Feature` and `tests/Unit`.

4.  **Create Architectural Test File:**
    *   As per the project standards, create a new file `tests/Arch.php` to define and enforce architectural rules across the codebase. This is a powerful feature of Pest that helps maintain a clean architecture.
    *   **File:** `tests/Arch.php`
    *   **Content:**
        ```php
        <?php

        // Enforce that all classes in an Action directory are final and invokable.
        test('actions')
            ->in('Domain\*\Actions')
            ->toBeFinal()
            ->toBeInvokable();

        // Enforce that controllers do not directly use Eloquent Models,
        // promoting the use of Actions or Repositories.
        test('controllers')
            ->in('App\Http\Controllers')
            ->not->toUse('Illuminate\Database\Eloquent\Model');

        // Add other architectural rules as needed.
        // e.g., ensuring all Form Requests end with 'Request'
        test('form requests')
            ->in('App\Http\Requests')
            ->toHaveSuffix('Request');
        ```

5.  **Run the Test Suite:**
    *   Execute the test suite using the `pest` command to ensure all tests pass.
    *   **Command:**
        ```bash
        ./vendor/bin/pest
        ```

### **Verification**

1.  The `tests/Pest.php` and `tests/Arch.php` files exist.
2.  All test files in `tests/Feature` and `tests/Unit` use the `test()` function syntax instead of PHPUnit classes.
3.  Running `./vendor/bin/pest` executes the full test suite successfully.
4.  The architectural tests in `tests/Arch.php` pass. Intentionally breaking a rule (e.g., using a Model in a Controller) and running `pest` causes the test suite to fail with a descriptive error.

### **Risks and Mitigation**

*   **Risk:** A test is missed or incorrectly converted during the manual refactoring process, leading to a gap in test coverage.
    *   **Mitigation:** Before starting the conversion, run the existing PHPUnit test suite and note the number of tests and assertions. After converting to Pest, run the new suite and ensure the test and assertion counts are identical.
